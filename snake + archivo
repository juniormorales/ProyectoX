#include <windows.h>
#include <iostream>
#include <conio.h>
#include <stdlib.h>
#include <fstream>
#define ARRIBA 72
#define ABAJO 80
#define IZQUIERDA 75
#define DERECHA 77
#define ESC 27
using namespace std;
int cuerpo[200][2];
char tecla;
int n=1;
int tam=3;
int x=10, y=12;
int dir=3;
int xc=30, yc=15;
int velocidad=100,h=1;
int score=0;

void gotoxy(int x,int y){  
      HANDLE hcon;  
      hcon = GetStdHandle(STD_OUTPUT_HANDLE);  
      COORD dwPos;  
      dwPos.X = x;  
      dwPos.Y= y;  
      SetConsoleCursorPosition(hcon,dwPos); 
}

void guardar_archivo_score(){
	ifstream leer_puntaje("punto.txt", ifstream::in);
	int cadena,num2;
	leer_puntaje>>cadena;
	num2=score;
	ofstream puntaje1("punto.txt");	
	if(num2>cadena)	
		puntaje1<<num2;
	else
		puntaje1<<cadena;
	puntaje1.close();			
}

void abrir_archivo_score(){
	ifstream leer_puntaje("punto.txt", ifstream::in);
	int cadena;
	leer_puntaje>>cadena;
	
	gotoxy(60,1); cout<<"Highest score: "<<cadena<<endl;
}

void pintar(){
	//lineas horizontales
	for(int i=2; i<78; i++){
		gotoxy(i,3); printf("%c",205);
		gotoxy(i,23); printf("%c",205);
	}
	//lineas verticales
	for(int i=4;i<23;i++){
		gotoxy(2,i); printf("%c",186);
		gotoxy(77,i); printf("%c",186);
	}
	//esquinas
	gotoxy(2,3); printf("%c",201);
	gotoxy(2,23); printf("%c",200);
	gotoxy(77,3); printf("%c",187);
	gotoxy(77,23); printf("%c",188);
	
}

void guardar_posicion(){
	//Posicion al incio y tamaÃ±o inicial
	cuerpo[n][0]=x;
	cuerpo[n][1]=y;
	n=n+1;
	if(n==tam) n=1;//para que el cuerpo se mantenga y no desaparesca
}

void dibujar_cuerpo(){//forma del cuerpo
	for(int i=1; i<tam;i++){
		gotoxy(cuerpo[i][0],cuerpo[i][1]);printf("%c",4);
	}
}

void borrar_cuerpo(){//mientras avanza se borran los espacios ya llenados
		gotoxy(cuerpo[n][0],cuerpo[n][1]);printf(" ");

}

void teclear(){
			//La tecla que presionas se guarda
		if(kbhit()){
			tecla=getch();
			switch(tecla){//direccion lineal, no retrocede
				case ARRIBA : if(dir!=2)
								dir=1;
						break;
				case ABAJO : if(dir!=1)
				 				dir=2;
				 		break;
				case DERECHA : if(dir!=4)
								dir=3;
						break;
				case IZQUIERDA : if(dir!=3)
								dir=4;
						break;
			}
		}
}

void comida(){
	if(x==xc && y==yc){//posicion aleatoria de la comida
		xc=(rand()%73)+4;
		yc=(rand()%19)+4;
		tam++;
		score=score+10;
		gotoxy(xc,yc);printf("%c",4);
	}
}

bool game_over(){
	if(y==3 || y==23 || x==2 || x==77)//choque con los limites
	return false;
	//recorrido de la matriz del inidice cuerpo
	for(int j=tam-1;j>0;j--){
		if(cuerpo[j][0]==x && cuerpo[j][1]==y)
		return false;
	}
	return true;	
}

void puntos(){
	gotoxy(3,1);printf("score %d", score);
}

void cambiar_velocidad(){//a mas puntaje la velocidad aumenta
	if(score==h*20){
		velocidad=velocidad-4;
		h++;
	}}

void menu(){
	//lineas horizontales
	for(int i=25; i<50; i++){
		gotoxy(i,9); printf("%c",205);
		gotoxy(i,14); printf("%c",205);
	}
	//lineas verticales
	for(int i=10;i<14;i++){
		gotoxy(25,i); printf("%c",186);
		gotoxy(50,i); printf("%c",186);
	}
	//esquinas
	gotoxy(25,9); printf("%c",201);
	gotoxy(25,14); printf("%c",200);
	gotoxy(50,9); printf("%c",187);
	gotoxy(50,14); printf("%c",188);
	//Datos
	gotoxy(33,8); cout<<"GAME OVER"<<endl;
	gotoxy(29,12); cout<<"Tu puntaje es: "<<score<<endl;

}

int main(){
	pintar();
	abrir_archivo_score();
	gotoxy(xc,yc);printf("%c",4);
	while(tecla!=ESC && game_over()){
		borrar_cuerpo();
		guardar_posicion();
		dibujar_cuerpo();
		comida();
		puntos();
		cambiar_velocidad();
		//se le llama dos veces para hacer movimientos bruscos
		teclear();
		teclear();
		if(dir==1)y--;//hacia arriba
		if(dir==2)y++;//hacia abajo
		if(dir==3)x++; //hacia derecha
		if(dir==4)x--;//hacia izquierda
		Sleep(velocidad);
	}
	system("cls");	
	guardar_archivo_score();	
	menu();	
	gotoxy(3,20);system("pause>null");
	return 0;
}
